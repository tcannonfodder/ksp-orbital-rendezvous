<!DOCTYPE html>
<html>
<head>
  <title></title>
  <script src="js/prototype.js"></script>
  <script src="js/raphael.js"></script>
  <script src="js/orbital-map.js"></script>
  <script src="js/telemachus.js"></script>
</head>
<body>

<form id="connection-info">
  <h2 id="connection-status"></h2>
  <input type="text" name="connection-host" id="connection-host" value="192.168.1.41">
  <input type="text" name="connection-port" id="connection-port" value="8085">

  <button type="submit">Connect</button>
</form>

<div id="orbital-map">
</div>

<div id="test"></div>
<script>
  document.observe('dom:loaded', function(){
    window.map = new OrbitalMap('orbital-map')

    var setupConnection = function(){
      window.targetOrbitingBodyName = ''
      window.targetOrbitingBodyID = ''
      window.vesselOrbitingBodyName = ''
      window.vesselOrbitingBodyID = ''

      var calculateDeltaV1 = function(data){
        var r1 = data['o.PeA']
        var r2 = data['tar.o.PeA']
        var mu = 10//data['b.o.gravParameter['+ vesselOrbitingBodyID +']']

        var factor1 = Math.sqrt(mu/r1)
        var factor2 = Math.sqrt((2 * r2)/(r1 + r2))

        var deltaV1 = factor1 * (factor2 - 1)

        console.log("delta V1: " + deltaV1)
      }

      var subscribeToTargetAndOrbitingBodyInfo = function(data){
        //get the name of the target's orbiting body
        window.targetOrbitingBodyName = data['tar.o.orbitingBody']
        window.targetOrbitingBodyID = window.datalink.getBodyId(targetOrbitingBodyName)

        window.vesselOrbitingBodyName = data['v.body']
        window.vesselOrbitingBodyID = window.datalink.getBodyId(targetOrbitingBodyName)

        console.log("Vessel Orbiting '"+ vesselOrbitingBodyName +"' ("+ vesselOrbitingBodyID +") ; Target Orbiting '"+ targetOrbitingBodyName +"' ("+ targetOrbitingBodyID +")")

        // window.datalink.subscribeToData([
          // "b.o.gravParameter["+ vesselOrbitingBodyID +"]",
          // "b.radis["+ vesselOrbitingBodyID +"]",
          // "b.soi["+ vesselOrbitingBodyID +"]"
        // ])
      }

      var calculatePhaseAngle = function(data){
        var r1 = data['o.PeA']
        var r2 = data['tar.o.PeA']
        var radius =  100 //data['b.radius['+ vesselOrbitingBodyID +']']
        var numberOfOrbits = Math.pow(0.5 * ( (r1 + r2 + (2*radius) )/((2*radius) + (2*r2)) ), 1.5)

        if(numberOfOrbits < 1){
          var fractionalPart = numberOfOrbits
        } else{
          var fractionalPart = (numberOfOrbits % 1)
        }

        var sweepAngle = 360 * fractionalPart
        var phaseAngle = 180 - sweepAngle

        var targetPhaseAngle = data["b.o.phaseAngle[2]"]

        console.log("Phase Angle: " + phaseAngle + " targetPhaseAngle: " + targetPhaseAngle)

        if(phaseAngle <= targetPhaseAngle + 30 && phaseAngle >= targetPhaseAngle - 30){
          console.log("FIRE EVERYTHING")
        }
      }



      window.datalink = new Telemachus($('connection-host').value,$('connection-port').value)
      window.datalink.socket.onopen = function(){
        window.datalink.subscribeToData([
          'v.altitude'//, 'o.PeA', 'v.orbitalVelocity',
          //'tar.o.PeA', 'tar.name', 'tar.o.orbitingBody', 'v.body'
        ])

        window.datalink.send({rate: 75})
        // window.datalink.addReceiverFunction(subscribeToTargetAndOrbitingBodyInfo)
        window.datalink.addReceiverFunction(calculateDeltaV1)
        window.datalink.addReceiverFunction(calculatePhaseAngle)

        $('connection-status').innerHTML = "CONNECTED"
      }

      window.datalink.onerror = function(){
        $('connection-status').innerHTML = "NOT CONNECTED"
      }

      window.datalink.onclose = function(){
        $('connection-status').innerHTML = "NOT CONNECTED"
      }
    }


    $('connection-info').observe('submit', function(event){
      event.preventDefault()
      setupConnection()
    })

    setupConnection()

    // window.socketTest = new WebSocket('ws://192.168.1.22:8085/datalink')
    // debugger
    // socketTest.onmessage = function(event){
    //   var data = JSON.parse(event.data)
    //   console.log(data)
    // }

    // socketTest.onopen = function(){
    //   debugger
    //   socketTest.send(JSON.stringify({ // any default key/values you want to send when the ui is started
    //     "+": ['v.name', 'p.paused', 'a.version'],
    //     "rate": 1000
    //   }))
    // }
  })
</script>
</body>
</html>